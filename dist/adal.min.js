/*! adal - v0.0.1 - Microsoft Open Technologies Inc - http://msopentech.com/ - 2014-10-23 */
"use strict";var AuthenticationContext;if("undefined"!=typeof module&&module.exports){var window,localStorage,angular,document;module.exports.inject=function(a,b,c,d,e,f){return window=a,localStorage=b,document=c,Math=d,angular=e,new AuthenticationContext(f)}}if(AuthenticationContext=function(a){if(this.REQUEST_TYPE={LOGIN:"LOGIN",RENEW_TOKEN:"RENEW_TOKEN",ID_TOKEN:"ID_TOKEN",UNKNOWN:"UNKNOWN"},this.CONSTANTS={STORAGE:{TOKEN_KEYS:"adal.token.keys",ACCESS_TOKEN_KEY:"adal.access.token.key",EXPIRATION_KEY:"adal.expiration.key",START_PAGE:"adal.start.page",FAILED_RENEW:"adal.failed.renew",STATE_LOGIN:"adal.state.login",STATE_RENEW:"adal.state.renew",STATE_RENEW_RESOURCE:"adal.state.renew.resource",STATE_IDTOKEN:"adal.state.idtoken",NONCE_IDTOKEN:"adal.nonce.idtoken",SESSION_STATE:"adal.session.state",USERNAME:"adal.username",IDTOKEN:"adal.idtoken",ERROR:"adal.error",ERROR_DESCRIPTION:"adal.error.description",LOGIN_REQUEST:"adal.login.request",LOGIN_ERROR:"adal.login.error"},RESOURCE_DELIMETER:"|",ERR_MESSAGES:{NO_TOKEN:"User is not authorized"}},AuthenticationContext.prototype._singletonInstance)return AuthenticationContext.prototype._singletonInstance;if(AuthenticationContext.prototype._singletonInstance=this,this.instance="https://login.windows.net/",this.config={},this.callback=null,this.popUp=!1,this._user=null,this._renewActive=!1,this._loginInProgress=!1,this._renewStates=[],a.displayCall&&"function"!=typeof a.displayCall)throw new Error("displayCall is not a function");if(!a.clientId)throw new Error("clientId is required");this.config=this._cloneConfig(a),this.config.loginResource||(this.config.loginResource=this.config.clientId),this.config.redirectUri||(this.config.redirectUri=window.location.href),this.config.resource=this.config.loginResource||""},AuthenticationContext.prototype.login=function(){var a=this._guid();this.config.state=a,this._idTokenNonce=this._guid(),this._logstatus("Expected state: "+a+" startPage:"+window.location),this._saveItem(this.CONSTANTS.STORAGE.LOGIN_REQUEST,window.location),this._saveItem(this.CONSTANTS.STORAGE.LOGIN_ERROR,""),this._saveItem(this.CONSTANTS.STORAGE.STATE_LOGIN,a),this._saveItem(this.CONSTANTS.STORAGE.NONCE_IDTOKEN,this._idTokenNonce),this._saveItem(this.CONSTANTS.STORAGE.FAILED_RENEW,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,"");var b=this._getNavigateUrl("id_token",null)+"&nonce="+encodeURIComponent(this._idTokenNonce);this.frameCallInProgress=!1,this._loginInProgress=!0,this.config.displayCall?this.config.displayCall(b):this.promptUser(b)},AuthenticationContext.prototype.loginInProgress=function(){return this._loginInProgress},AuthenticationContext.prototype._hasResource=function(a){var b=this._getItem(this.CONSTANTS.STORAGE.TOKEN_KEYS);return b&&!this._isEmpty(b)&&b.indexOf(a+this.CONSTANTS.RESOURCE_DELIMETER)>-1},AuthenticationContext.prototype.getCachedToken=function(a){if(!this._hasResource(a))return null;var b=this._getItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+a),c=this._getItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+a),d=this.config.expireOffsetSeconds||120;return c&&c>this._now()+d?b:(this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+a,""),this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+a,0),null)},AuthenticationContext.prototype.getCachedUser=function(){if(this._user)return this._user;var a=this._getItem(this.CONSTANTS.STORAGE.IDTOKEN);return this._user=this._createUser(a),this._user},AuthenticationContext.prototype._renewToken=function(a,b){if(this._logstatus("renewToken is called for resource:"+a),!this._hasResource(a)){var c=this._getItem(this.CONSTANTS.STORAGE.TOKEN_KEYS)||"";this._saveItem(this.CONSTANTS.STORAGE.TOKEN_KEYS,c+a+this.CONSTANTS.RESOURCE_DELIMETER)}var d=this._addAdalFrame("adalRenewFrame"),e=this._guid()+"|"+a;this.config.state=e,this._renewStates.push(e),this._saveItem(this.CONSTANTS.STORAGE.FAILED_RENEW,""),this._logstatus("Renew token Expected state: "+e);var f=this._getNavigateUrl("token",a)+"&prompt=none&login_hint="+encodeURIComponent(this._user.userName);f+="&domain_hint="+encodeURIComponent(this._getDomainHint()),f+="&nonce="+encodeURIComponent(this._idTokenNonce),this.callback=b,this.idTokenNonce=null,this._logstatus("Navigate to:"+f),this._saveItem(this.CONSTANTS.STORAGE.LOGIN_REQUEST,""),d.src="about:blank",this._loadFrame(f,"adalRenewFrame")},AuthenticationContext.prototype._renewIdToken=function(a){if(this._logstatus("renewIdToken is called"),!this._hasResource(this.config.clientId)){var b=this._getItem(this.CONSTANTS.STORAGE.TOKEN_KEYS)||"";this._saveItem(this.CONSTANTS.STORAGE.TOKEN_KEYS,b+this.config.clientId+this.CONSTANTS.RESOURCE_DELIMETER)}var c=this._addAdalFrame("adalIdTokenFrame"),d=this._guid()+"|"+this.config.clientId;this._idTokenNonce=this._guid(),this._saveItem(this.CONSTANTS.STORAGE.NONCE_IDTOKEN,this._idTokenNonce),this.config.state=d,this._renewStates.push(d),this._saveItem(this.CONSTANTS.STORAGE.STATE_RENEW,d),this._saveItem(this.CONSTANTS.STORAGE.FAILED_RENEW,""),this._logstatus("Renew token Expected state: "+d);var e=this._getNavigateUrl("id_token",null)+"&prompt=none&login_hint="+encodeURIComponent(this._user.userName);e+="&domain_hint="+encodeURIComponent(this._getDomainHint()),e+="&nonce="+encodeURIComponent(this._idTokenNonce),this.callback=a,this.idTokenNonce=null,this._logstatus("Navigate to:"+e),this._saveItem(this.CONSTANTS.STORAGE.LOGIN_REQUEST,""),c.src="about:blank",this._loadFrame(e,"adalIdTokenFrame")},AuthenticationContext.prototype._loadFrame=function(a,b){var c=this;setTimeout(function(){var d=c._addAdalFrame(b);(""===d.src||"about:blank"===d.src)&&(d.src=a,c._loadFrame(a))},500)},AuthenticationContext.prototype.acquireToken=function(a,b){if(this._isEmpty(a))return void b("resource is required",null);var c=this.getCachedToken(a);return c?(this._logstatus("Token in cache"),void b(null,c)):this._getItem(this.CONSTANTS.STORAGE.FAILED_RENEW)?(this._logstatus("renewToken is failed:"+this._getItem(this.CONSTANTS.STORAGE.FAILED_RENEW)),void b(this._getItem(this.CONSTANTS.STORAGE.FAILED_RENEW),null)):this._user?(this._renewActive=!0,void(a===this.config.clientId?(this._logstatus("renewing idtoken"),this._renewIdToken(b)):this._renewToken(a,b))):void b("User login is required",null)},AuthenticationContext.prototype.promptUser=function(a){a?(this._logstatus("Navigate to:"+a),window.location.replace(a)):this._logstatus("Navigate url is empty")},AuthenticationContext.prototype.clearCache=function(){this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY,""),this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY,0),this._saveItem(this.CONSTANTS.STORAGE.FAILED_RENEW,""),this._saveItem(this.CONSTANTS.STORAGE.SESSION_STATE,""),this._saveItem(this.CONSTANTS.STORAGE.STATE_LOGIN,""),this._renewStates=[],this._saveItem(this.CONSTANTS.STORAGE.STATE_IDTOKEN,""),this._saveItem(this.CONSTANTS.STORAGE.START_PAGE,""),this._saveItem(this.CONSTANTS.STORAGE.USERNAME,""),this._saveItem(this.CONSTANTS.STORAGE.IDTOKEN,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,"");var a=this._getItem(this.CONSTANTS.STORAGE.TOKEN_KEYS);if(!this._isEmpty(a)){a=a.split(this.CONSTANTS.RESOURCE_DELIMETER);for(var b=0;b<a.length;b++)this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+a[b],""),this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+a[b],0)}this._saveItem(this.CONSTANTS.STORAGE.TOKEN_KEYS,"")},AuthenticationContext.prototype.clearCacheForResource=function(a){this._saveItem(this.CONSTANTS.STORAGE.FAILED_RENEW,""),this._saveItem(this.CONSTANTS.STORAGE.STATE_RENEW,""),this._saveItem(this.CONSTANTS.STORAGE.STATE_IDTOKEN,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,""),this._hasResource(a)&&(this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+a,""),this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+a,0))},AuthenticationContext.prototype.logOut=function(){this.clearCache();var a="common",b="";this._user=null,this.config.tenant&&(a=this.config.tenant),this.config.instance&&(this.instance=this.config.instance),this.config.postLogoutRedirectUri&&(b="post_logout_redirect_uri="+encodeURIComponent(this.config.postLogoutRedirectUri));var c=this.instance+a+"/oauth2/logout?"+b;this._logstatus("Logout navigate to: "+c),this.promptUser(c)},AuthenticationContext.prototype._isEmpty=function(a){return"undefined"==typeof a||!a||0===a.length},AuthenticationContext.prototype.getUser=function(a){if("function"!=typeof a)throw new Error("callback is not a function");if(this.callback=a,this._user)return void this.callback(null,this._user);var b=this._getItem(this.CONSTANTS.STORAGE.IDTOKEN);this._isEmpty(b)?this.callback("User information is not available"):(this._logstatus("User exists in cache: "),this._user=this._createUser(b),this.callback(null,this._user))},AuthenticationContext.prototype._getDomainHint=function(){if(this._user&&this._user.userName&&this._user.userName.indexOf("@")>-1){var a=this._user.userName.split("@");return a[a.length-1]}return""},AuthenticationContext.prototype._createUser=function(a){var b=null,c=this._extractIdToken(a);return c&&c.hasOwnProperty("aud")&&(c.aud.toLowerCase()===this.config.clientId.toLowerCase()?(b={userName:"",profile:c},c.hasOwnProperty("upn")?b.userName=c.upn:c.hasOwnProperty("email")&&(b.userName=c.email)):this._logstatus("IdToken has invalid aud field")),b},AuthenticationContext.prototype._getHash=function(a){return a.indexOf("#/")>-1?a=a.substring(a.indexOf("#/")+2):a.indexOf("#")>-1&&(a=a.substring(1)),a},AuthenticationContext.prototype.isCallback=function(a){a=this._getHash(a);var b=this._deserialize(a);return b.hasOwnProperty("error_description")||b.hasOwnProperty("access_token")||b.hasOwnProperty("id_token")},AuthenticationContext.prototype.getLoginError=function(){return this._getItem(this.CONSTANTS.STORAGE.LOGIN_ERROR)},AuthenticationContext.prototype.getRequestInfo=function(a){a=this._getHash(a);var b=this._deserialize(a),c={valid:!1,parameters:{},stateMatch:!1,stateResponse:"",requestType:this.REQUEST_TYPE.UNKNOWN};if(b&&(c.parameters=b,b.hasOwnProperty("error_description")||b.hasOwnProperty("access_token")||b.hasOwnProperty("id_token"))){c.valid=!0;var d="";switch(b.hasOwnProperty("state")?(this._logstatus("State: "+b.state),d=b.state):this._logstatus("No state returned"),c.stateResponse=d,d){case this._getItem(this.CONSTANTS.STORAGE.STATE_LOGIN):c.requestType=this.REQUEST_TYPE.LOGIN,c.stateMatch=!0;break;case this._getItem(this.CONSTANTS.STORAGE.STATE_IDTOKEN):c.requestType=this.REQUEST_TYPE.ID_TOKEN,this._saveItem(this.CONSTANTS.STORAGE.STATE_IDTOKEN,""),c.stateMatch=!0}if(!c.stateMatch&&window.parent&&window.parent.AuthenticationContext())for(var e=window.parent.AuthenticationContext()._renewStates,f=0;f<e.length;f++)if(e[f]===c.stateResponse){c.requestType=this.REQUEST_TYPE.RENEW_TOKEN,c.stateMatch=!0;break}}return c},AuthenticationContext.prototype._getResourceFromState=function(a){if(a){var b=a.indexOf("|");if(b>-1&&b+1<a.length)return a.substring(b+1)}return""},AuthenticationContext.prototype.saveTokenFromHash=function(a){if(this._logstatus("State status:"+a.stateMatch),this._saveItem(this.CONSTANTS.STORAGE.ERROR,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,""),a.parameters.hasOwnProperty("error_description"))this._logstatus("Error :"+a.parameters.error),this._logstatus("Error description:"+a.parameters.error_description),this._saveItem(this.CONSTANTS.STORAGE.FAILED_RENEW,a.parameters.error_description),this._saveItem(this.CONSTANTS.STORAGE.ERROR,a.parameters.error),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,a.parameters.error_description),a.requestType===this.REQUEST_TYPE.LOGIN?(this._loginInProgress=!1,this._saveItem(this.CONSTANTS.STORAGE.LOGIN_ERROR,a.parameters.errorDescription)):this._renewActive=!1;else if(a.stateMatch){if(this._logstatus("State is right"),a.parameters.hasOwnProperty("session_state")&&this._saveItem(this.CONSTANTS.STORAGE.SESSION_STATE,a.parameters.session_state),a.parameters.hasOwnProperty("access_token")){this._logstatus("Fragment has access token"),this._renewActive=!1;var b=this.config.loginResource;if(!this._hasResource(b)){var c=this._getItem(this.CONSTANTS.STORAGE.TOKEN_KEYS)||"";this._saveItem(this.CONSTANTS.STORAGE.TOKEN_KEYS,c+b+this.CONSTANTS.RESOURCE_DELIMETER)}a.requestType===this.REQUEST_TYPE.RENEW_TOKEN&&(b=this._getResourceFromState(a.stateResponse)),this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+b,a.parameters.access_token),this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+b,this._expiresIn(a.parameters.expires_in))}if(a.parameters.hasOwnProperty("id_token")&&(this._loginInProgress=!1,this._user=this._createUser(a.parameters.id_token),this._user&&this._user.profile))if(this._user.profile.nonce!==this._getItem(this.CONSTANTS.STORAGE.NONCE_IDTOKEN))this._user=null,this._saveItem(this.CONSTANTS.STORAGE.LOGIN_ERROR,"Nonce is not same as "+this._idTokenNonce);else{this._saveItem(this.CONSTANTS.STORAGE.IDTOKEN,a.parameters.id_token);var b=this.config.clientId;if(!this._hasResource(b)){var c=this._getItem(this.CONSTANTS.STORAGE.TOKEN_KEYS)||"";this._saveItem(this.CONSTANTS.STORAGE.TOKEN_KEYS,c+b+this.CONSTANTS.RESOURCE_DELIMETER)}this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+b,a.parameters.id_token),this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+b,this._user.profile.exp)}}else this._saveItem(this.CONSTANTS.STORAGE.ERROR,"Invalid_state"),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,"Invalid_state"),a.requestType===this.REQUEST_TYPE.LOGIN&&this._saveItem(this.CONSTANTS.STORAGE.LOGIN_ERROR,"State is not same as "+a.stateResponse)},AuthenticationContext.prototype.getResourceForEndpoint=function(a){if(this.config&&this.config.endpoints)for(var b in this.config.endpoints)if(a.indexOf(b)>-1)return this.config.endpoints[b];return this.config.loginResource},AuthenticationContext.prototype.handleWindowCallback=function(){var a=window.location.hash;if(this.isCallback(a)){var b=this.getRequestInfo(a);this.saveTokenFromHash(b);var c=null;if(b.requestType!==this.REQUEST_TYPE.RENEW_TOKEN&&b.requestType!==this.REQUEST_TYPE.ID_TOKEN||!window.parent?window&&window.oauth2Callback&&(console.log("Window is redirecting"),c=this.callback):(console.log("Window is in iframe"),c=window.parent.AuthenticationContext().callback,window.src=""),window.location.hash="",b.requestType===this.REQUEST_TYPE.RENEW_TOKEN)return void c(this._getItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION),b.parameters.access_token);if(b.requestType===this.REQUEST_TYPE.ID_TOKEN)return void c(this._getItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION),this._createUser(this._getItem(this.CONSTANTS.STORAGE.IDTOKEN)))}},AuthenticationContext.prototype._getNavigateUrl=function(a,b){var c="common";this.config.tenant&&(c=this.config.tenant),this.config.instance&&(this.instance=this.config.instance);var d=this.instance+c+"/oauth2/authorize"+this._serialize(a,this.config,b);return console.log("Navigate url:"+d),d},AuthenticationContext.prototype._extractIdToken=function(a){var b=this._crackJwt(a);if(!b)return null;try{var c=b.JWSPayload,d=this._base64DecodeStringUrlSafe(c);return d?JSON.parse(d):(this._logstatus("The returned id_token could not be base64 url safe decoded."),null)}catch(e){this._logstatus("The returned id_token could not be decoded: "+e.stack)}return null},AuthenticationContext.prototype._extractUserName=function(a){try{var b=this._extractIdToken(a);if(b){if(b.hasOwnProperty("upn"))return b.upn;if(b.hasOwnProperty("email"))return b.email}}catch(c){this._logstatus("The returned id_token could not be decoded: "+c.stack)}return null},AuthenticationContext.prototype._base64DecodeStringUrlSafe=function(a){return window.atob?window.atob(a):(this._logstatus("Browser is not supported"),null)},AuthenticationContext.prototype._crackJwt=function(a){var b=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/,c=b.exec(a);if(!c||c.length<4)return this._logstatus("The returned id_token is not parseable."),null;var d={header:c[1],JWSPayload:c[2],JWSSig:c[3]};return d},AuthenticationContext.prototype._convertUrlSafeToRegularBase64EncodedString=function(a){return a.replace("-","+").replace("_","/")},AuthenticationContext.prototype._serialize=function(a,b,c){var d=[];return null!==b&&(d.push("?response_type="+a),d.push("client_id="+encodeURIComponent(b.clientId)),c&&d.push("resource="+encodeURIComponent(c)),d.push("redirect_uri="+encodeURIComponent(b.redirectUri)),d.push("state="+encodeURIComponent(b.state)),b.hasOwnProperty("slice")&&d.push("slice="+encodeURIComponent(b.slice)),b.hasOwnProperty("extraQueryParameter")&&d.push(b.extraQueryParameter)),d.join("&")},AuthenticationContext.prototype._deserialize=function(a){var b,c=/\+/g,d=/([^&=]+)=?([^&]*)/g,e=function(a){return decodeURIComponent(a.replace(c," "))},f={};for(b=d.exec(a);b;)f[e(b[1])]=e(b[2]),b=d.exec(a);return f},AuthenticationContext.prototype._guid=function(){for(var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",b="0123456789abcdef",c=0,d="",e=0;36>e;e++)"-"!==a[e]&&"4"!==a[e]&&(c=16*Math.random()|0),"x"===a[e]?d+=b[c]:"y"===a[e]?(c&=3,c|=8,d+=b[c]):d+=a[e];return d},AuthenticationContext.prototype._expiresIn=function(a){return this._now()+parseInt(a,10)},AuthenticationContext.prototype._now=function(){return Math.round((new Date).getTime()/1e3)},AuthenticationContext.prototype._addAdalFrame=function(a){this._logstatus("Add adal frame to document:"+a);var b=document.getElementById(a);if(!b){if(document.createElement&&document.documentElement&&(window.opera||-1===window.navigator.userAgent.indexOf("MSIE 5.0"))){var c=document.createElement("iframe");c.setAttribute("id",a),c.style.visibility="hidden",c.style.position="absolute",c.style.width=c.style.height=c.borderWidth="0px",b=document.getElementsByTagName("body")[0].appendChild(c)}else document.body&&document.body.insertAdjacentHTML&&document.body.insertAdjacentHTML("beforeEnd",'<iframe name="'+a+'" id="'+a+'" style="display:none"></iframe>');window.frames&&window.frames[a]&&(b=window.frames[a])}return b},AuthenticationContext.prototype._logstatus=function(a){console&&console.log(a)},AuthenticationContext.prototype._saveItem=function(a,b){return this._supportsLocalStorage()?(localStorage.setItem(a,b),!0):(this._logStatus("Local storage is not supported"),!1)},AuthenticationContext.prototype._getItem=function(a){return this._supportsLocalStorage()?localStorage.getItem(a):(this._logstatus("Local storage is not supported"),null)},AuthenticationContext.prototype._supportsLocalStorage=function(){try{return"localStorage"in window&&window.localStorage}catch(a){return!1}},AuthenticationContext.prototype._cloneConfig=function(a){if(null===a||"object"!=typeof a)return a;var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},"undefined"!=typeof angular){var AdalModule=angular.module("AdalAngular",[]);AdalModule.factory("ProtectedResourceInterceptor",["$q","$rootScope","$injector",function(a,b,c){var d,e=function(){d=d||c.get("adalAuthenticationService")};return{request:function(b){if(b){if(!c.has("adalAuthenticationService"))return b;e(),d=d||c.get("adalAuthenticationService"),b.headers=b.headers||{};var f=d.getResourceForEndpoint(b.url),g=d.getCachedToken(f);if(g)return b.headers.Authorization="Bearer "+g,b;if(d.loginInProgress())return void a.reject();if(d.config&&f!==d.config.clientId){var h=a.defer();return d.acquireToken(f).then(function(a){b.headers.Authorization="Bearer "+a,h.resolve(b)},function(a){this._logstatus("err :"+error),h.reject(a)}),h.promise}}},responseError:function(c){if(401===c.status){e();var f=d.getResourceForEndpoint(c.config.url);d.clearCacheForResource(f),b.$broadcast("adal:notAuthorized",c,f)}return a.reject(c)}}}]);var AdalService=function(){var a=null,b={isAuthenticated:!1,userName:"",loginError:"",profile:""},c=function(c){var d=a.getCachedToken(c);b.isAuthenticated=null!==d&&d.length>0;var e=a.getCachedUser()||{userName:""};b.userName=e.userName,b.profile=e.profile,b.loginError=a.getLoginError()};this.init=function(b,d){if(!b)throw new Error("You must set configOptions, when calling init");var e=window.location.hash,f=window.location.href;e&&(f=f.replace(e,"")),b.redirectUri=b.redirectUri||f,b.postLogoutRedirectUri=b.postLogoutRedirectUri||f,d&&d.interceptors&&d.interceptors.push("ProtectedResourceInterceptor"),a=new AuthenticationContext(b),c(a.config.loginResource)},this.$get=function(d,e,f,g,h,i){var j=function(){var f=e.location.hash;if(a.isCallback(f)){var g=a.getRequestInfo(f);if(a.saveTokenFromHash(g),e.location.hash="",g.requestType!==a.REQUEST_TYPE.LOGIN&&(a.callback=e.parent.AuthenticationContext().callback),g.stateMatch)if("function"==typeof a.callback){if(g.requestType===a.REQUEST_TYPE.RENEW_TOKEN){if(g.parameters.access_token)return void a.callback(a._getItem(a.CONSTANTS.STORAGE.ERROR_DESCRIPTION),g.parameters.access_token);if(g.parameters.id_token)return void a.callback(a._getItem(a.CONSTANTS.STORAGE.ERROR_DESCRIPTION),g.parameters.id_token)}}else c(a.config.loginResource),b.userName?(i(function(){c(a.config.loginResource),d.userInfo=b;var e=a._getItem(a.CONSTANTS.STORAGE.START_PAGE);e&&h.path(e)},1),d.$broadcast("adal:loginSuccess")):d.$broadcast("adal:loginFailure",a._getItem(a.CONSTANTS.STORAGE.ERROR_DESCRIPTION))}else c(a.config.loginResource),a._renewActive||b.isAuthenticated||!b.userName||a._getItem(a.CONSTANTS.STORAGE.FAILED_RENEW)||a.acquireToken(a.config.loginResource,function(a,c){a?d.$broadcast("adal:loginFailure","auto renew failure"):c&&(b.isAuthenticated=!0)});i(function(){c(a.config.loginResource),d.userInfo=b},1)},k=function(c,e){e.$$route&&e.$$route.requireADLogin&&(b.isAuthenticated||(console.log("Route change event for:"+e.$$route.originalPath),a.config&&a.config.localLoginUrl?h.path(a.config.localLoginUrl):(a._saveItem(a.CONSTANTS.STORAGE.START_PAGE,e.$$route.originalPath),console.log("Start login at:"+window.location.href),d.$broadcast("adal:loginRedirect"),a.login())))};return d.$on("$routeChangeStart",k),d.$on("$locationChangeStart",j),c(a.config.loginResource),d.userInfo=b,{config:a.config,login:function(){a.login()},loginInProgress:function(){return a.loginInProgress()},logOut:function(){a.logOut()},getCachedToken:function(b){return a.getCachedToken(b)},userInfo:b,acquireToken:function(b){var c=g.defer();return a.acquireToken(b,function(a,b){a?(this._logstatus("err :"+a),c.reject(a)):c.resolve(b)}),c.promise},getUser:function(){var b=g.defer();return a.getUser(function(a,c){a?(this._logstatus("err :"+a),b.reject(a)):b.resolve(c)}),b.promise},getResourceForEndpoint:function(b){return a.getResourceForEndpoint(b)},clearCache:function(){a.clearCache()},clearCacheForResource:function(b){a.clearCacheForResource(b)}}}};AdalModule.provider("adalAuthenticationService",function(){return new AdalService})}else console.log("Angular.JS is not included");